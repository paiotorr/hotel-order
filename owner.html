<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Paiotorr â€“ Owner Dashboard</title>

<style>
html,body{
  margin:0;
  padding:0;
  font-family:Arial, sans-serif;
  background:#ffffff;
}
body{ padding:20px; }

h1{ margin-bottom:14px; }

.main{
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:16px;
}

.pending{
  border:2px solid #f1c40f;
  border-radius:12px;
  padding:14px;
  height:55vh;
  overflow-y:auto;
}

.right{
  display:grid;
  grid-template-rows:1fr 1fr;
  gap:16px;
  height:55vh;
}

.accepted,.rejected{
  border-radius:12px;
  padding:14px;
  overflow-y:auto;
}

.accepted{ border:2px solid #2ecc71; }
.rejected{ border:2px solid #e74c3c; }

h2{
  margin:0 0 8px;
  position:sticky;
  top:0;
  background:#fff;
}

.order{
  border:2px solid #ccc;
  border-radius:12px;
  padding:12px;
  margin-bottom:12px;
}

.header{
  display:flex;
  justify-content:space-between;
}

.table{ font-weight:bold; }
.time{ font-size:13px; color:#555; }

.customer{ font-weight:bold; margin:6px 0; }

.item{
  display:flex;
  align-items:center;
  margin-bottom:8px;
}

.item img{
  width:70px;
  height:70px;
  border-radius:8px;
  margin-right:10px;
  object-fit:cover;
  border:1px solid #ccc;
}

.itemText{ font-weight:bold; }

.total{ font-weight:bold; margin-top:6px; }

.actions{ margin-top:8px; }

.actions button{
  padding:8px 14px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  margin-right:6px;
}

.acceptBtn{ background:#2ecc71;color:#fff; }
.rejectBtn{ background:#e74c3c;color:#fff; }

/* ANALYTICS */
.filterBox{
  margin-top:22px;
  padding-top:16px;
  border-top:3px solid #000;
}

.analyticsItem{
  border:2px solid #000;
  border-radius:12px;
  padding:12px;
  margin-bottom:12px;
}

.analyticsItem h3{
  margin:0 0 6px;
}

.bar{
  height:14px;
  border-radius:8px;
  background:#ddd;
  overflow:hidden;
  margin:4px 0 6px;
}

.acceptBar{ height:100%; background:#2ecc71; }
.rejectBar{ height:100%; background:#e74c3c; }

.topBadge{
  display:inline-block;
  padding:4px 8px;
  border-radius:6px;
  font-size:12px;
  font-weight:bold;
  margin-left:6px;
}
</style>
</head>

<body>

<h1>ðŸ“‹ Paiotorr â€“ Owner</h1>

<div class="main">
  <div class="pending">
    <h2>ðŸŸ¡ Pending Orders</h2>
    <div id="pending"></div>
  </div>

  <div class="right">
    <div class="accepted">
      <h2>ðŸŸ¢ Accepted</h2>
      <div id="accepted"></div>
    </div>

    <div class="rejected">
      <h2>ðŸ”´ Rejected</h2>
      <div id="rejected"></div>
    </div>
  </div>
</div>

<div class="filterBox">
  <h2>ðŸ“Š Item Analytics (Top 3 Items)</h2>
  <div id="analytics"></div>
</div>

<audio id="bellSound" preload="auto">
  <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
</audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getFirestore,
  collection,
  onSnapshot,
  doc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyDSf51jWs3I4AXX0U8M_HxKn4VtRYg72xs",
  authDomain:"hotel-order-7f1f2.firebaseapp.com",
  projectId:"hotel-order-7f1f2"
});
const db = getFirestore(app);

const pendingDiv = document.getElementById("pending");
const acceptedDiv = document.getElementById("accepted");
const rejectedDiv = document.getElementById("rejected");
const analyticsDiv = document.getElementById("analytics");
const bell = document.getElementById("bellSound");

const DEFAULT_IMG="https://raw.githubusercontent.com/paiotorr/Paiotorr/main/image/Pizza.jpg";

let allOrders = [];
let firstLoad = true;

/* REALTIME */
onSnapshot(collection(db,"orders"), snap => {
  let newPendingArrived = false;
  allOrders = [];

  snap.docChanges().forEach(change=>{
    if(change.type==="added" && change.doc.data().status==="pending" && !firstLoad){
      newPendingArrived = true;
    }
  });

  snap.forEach(d=>{
    const data = d.data();

    let createdAt;
    if(data.createdAt && data.createdAt.toDate){
      createdAt = data.createdAt.toDate();
    }else if(data.time){
      createdAt = new Date(data.time);
    }else{
      createdAt = new Date();
    }

    allOrders.push({ id:d.id, ...data, createdAt });
  });

  if(newPendingArrived){
    bell.currentTime = 0;
    bell.play().catch(()=>{});
  }

  firstLoad = false;

  allOrders.sort((a,b)=>b.createdAt - a.createdAt);

  render(allOrders);
  renderAnalytics(allOrders);
});

/* RENDER */
function render(list){
  pendingDiv.innerHTML="";
  acceptedDiv.innerHTML="";
  rejectedDiv.innerHTML="";

  list.forEach(o=>{
    let items="";
    o.items.forEach(i=>{
      items+=`
      <div class="item">
        <img src="${i.img || DEFAULT_IMG}">
        <div class="itemText">${i.name} Ã— ${i.qty}</div>
      </div>`;
    });

    const card=`
    <div class="order">
      <div class="header">
        <div class="table">Table ${o.table}</div>
        <div class="time">${o.createdAt.toLocaleString()}</div>
      </div>
      <div class="customer">ðŸ‘¤ ${o.customer}</div>
      ${items}
      <div class="total">â‚¹${o.total}</div>
      ${
        o.status==="pending"
        ? `<div class="actions">
            <button class="acceptBtn" onclick="setStatus('${o.id}','accepted')">Accept</button>
            <button class="rejectBtn" onclick="setStatus('${o.id}','rejected')">Reject</button>
          </div>`
        : ""
      }
    </div>`;

    if(o.status==="pending") pendingDiv.innerHTML+=card;
    if(o.status==="accepted") acceptedDiv.innerHTML+=card;
    if(o.status==="rejected") rejectedDiv.innerHTML+=card;
  });
}

/* ANALYTICS */
function renderAnalytics(orders){
  const stats = {};

  orders.forEach(o=>{
    o.items.forEach(i=>{
      if(!stats[i.name]) stats[i.name]={total:0,accepted:0,rejected:0};
      stats[i.name].total+=i.qty;
      if(o.status==="accepted") stats[i.name].accepted+=i.qty;
      if(o.status==="rejected") stats[i.name].rejected+=i.qty;
    });
  });

  const sorted = Object.entries(stats).sort((a,b)=>b[1].total-a[1].total).slice(0,3);
  analyticsDiv.innerHTML="";

  sorted.forEach(([name,s],i)=>{
    const accP = s.total?Math.round(s.accepted/s.total*100):0;
    const rejP = s.total?Math.round(s.rejected/s.total*100):0;
    const badge = i===0?"ðŸ¥‡ Top 1":i===1?"ðŸ¥ˆ Top 2":"ðŸ¥‰ Top 3";

    analyticsDiv.innerHTML+=`
    <div class="analyticsItem">
      <h3>${name} <span class="topBadge">${badge}</span></h3>
      <div><b>Total Orders:</b> ${s.total}</div>
      <div><b>Accepted:</b> ${s.accepted} (${accP}%)</div>
      <div class="bar"><div class="acceptBar" style="width:${accP}%"></div></div>
      <div><b>Rejected:</b> ${s.rejected} (${rejP}%)</div>
      <div class="bar"><div class="rejectBar" style="width:${rejP}%"></div></div>
    </div>`;
  });
}

window.setStatus = async (id,status)=>{
  await updateDoc(doc(db,"orders",id),{ status });
};
</script>

</body>
</html>