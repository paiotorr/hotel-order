<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Owner Dashboard</title>

<style>
body{
  margin:0;
  padding:20px;
  font-family: Arial, sans-serif;
  background:#ffffff;
}

h1{margin-bottom:20px;}

.clearAll{
  margin-bottom:20px;
  padding:14px 22px;
  font-size:18px;
  background:#000;
  color:#fff;
  border:none;
  border-radius:8px;
  cursor:pointer;
}

.layout{
  display:grid;
  grid-template-columns: 2fr 1fr;
  gap:20px;
}

.pending{border:2px solid #f1c40f;}
.accepted{border:2px solid #2ecc71;}
.rejected{border:2px solid #e74c3c;}

.pending,.accepted,.rejected{
  border-radius:12px;
  padding:20px;
}

.pending h2{color:#f39c12;}
.accepted h2{color:#27ae60;}
.rejected h2{color:#c0392b;}

.right{
  display:flex;
  flex-direction:column;
  gap:20px;
}

.order{
  border:2px solid #ccc;
  border-radius:12px;
  padding:18px;
  margin-bottom:18px;
}

.orderHeader{
  display:flex;
  justify-content:space-between;
  margin-bottom:12px;
}

.table{
  font-size:22px;
  font-weight:bold;
}

.time{
  font-size:15px;
  color:#555;
}

.item{
  display:flex;
  align-items:center;
  margin-bottom:18px;
}

.item img{
  width:160px;
  height:160px;
  object-fit:cover;
  border-radius:18px;
  margin-right:22px;
  border:2px solid #ccc;
}

.itemName{
  font-size:30px;
  font-weight:900;
}

.actions button{
  padding:14px 20px;
  font-size:18px;
  margin-right:10px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}

.accept{background:#2ecc71;color:#fff;}
.reject{background:#e74c3c;color:#fff;}
.clear{background:#555;color:#fff;}

.statusIcon{
  font-size:60px;
  margin-top:14px;
}

.tick{color:#2ecc71;}
.cross{color:#e74c3c;}
</style>
</head>

<body>

<h1>ðŸ“‹ Paiotorr</h1>
<button class="clearAll" onclick="clearAllOrders()">Clear ALL Accepted & Rejected</button>

<div class="layout">

  <div class="pending">
    <h2>ðŸŸ¡ Pending Orders</h2>
    <div id="pending"></div>
  </div>

  <div class="right">
    <div class="accepted">
      <h2>ðŸŸ¢ Accepted</h2>
      <div id="accepted"></div>
    </div>

    <div class="rejected">
      <h2>ðŸ”´ Rejected</h2>
      <div id="rejected"></div>
    </div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getFirestore, collection, onSnapshot,
  doc, updateDoc, deleteDoc,
  getDocs, query, orderBy
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* ðŸ”Š SOUND FUNCTION */
function playBeep(){
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();

  osc.type = "sine";
  osc.frequency.value = 880; // beep tone
  gain.gain.value = 0.2;

  osc.connect(gain);
  gain.connect(ctx.destination);

  osc.start();
  osc.stop(ctx.currentTime + 0.2);
}

/* IMAGE MAP (SAFE) */
const IMAGE_MAP = {
  "Pizza": "https://raw.githubusercontent.com/paiotorr/Paiotorr/main/image/Pizza.jpg",
  "Burger": "https://images.unsplash.com/photo-1550547660-d9450f859349"
};

const PLACEHOLDER = "https://via.placeholder.com/160?text=Item";

const firebaseConfig = {
  apiKey: "AIzaSyDSf51jWs3I4AXX0U8M_HxKn4VtRYg72xs",
  authDomain: "hotel-order-7f1f2.firebaseapp.com",
  projectId: "hotel-order-7f1f2"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const pendingDiv  = document.getElementById("pending");
const acceptedDiv = document.getElementById("accepted");
const rejectedDiv = document.getElementById("rejected");

/* ðŸ”” TRACK NEW ORDERS */
let knownOrders = new Set();

const q = query(collection(db,"orders"), orderBy("time","desc"));

onSnapshot(q, snap => {
  pendingDiv.innerHTML="";
  acceptedDiv.innerHTML="";
  rejectedDiv.innerHTML="";

  snap.forEach(docSnap=>{
    const o = docSnap.data();

    /* ðŸ”” PLAY SOUND ONLY FOR NEW PENDING ORDER */
    if(!knownOrders.has(docSnap.id) && o.status==="pending"){
      playBeep();
      knownOrders.add(docSnap.id);
    }

    const items = Array.isArray(o.items)
      ? o.items
      : Object.values(o.items || {});

    let itemsHTML="";
    items.forEach(i=>{
      const img = IMAGE_MAP[i.name] || PLACEHOLDER;
      itemsHTML += `
        <div class="item">
          <img src="${img}">
          <div class="itemName">${i.name} Ã— ${i.qty || 1}</div>
        </div>`;
    });

    const card = `
      <div class="order">
        <div class="orderHeader">
          <div class="table">Table ${o.table}</div>
          <div class="time">ðŸ•’ ${o.time}</div>
        </div>
        ${itemsHTML}
      </div>`;

    if(o.status==="pending"){
      pendingDiv.innerHTML += card.replace(
        "</div>",
        `<div class="actions">
          <button class="accept" onclick="setStatus('${docSnap.id}','accepted')">Accept</button>
          <button class="reject" onclick="setStatus('${docSnap.id}','rejected')">Reject</button>
          <button class="clear" onclick="clearOne('${docSnap.id}')">Clear</button>
        </div></div>`
      );
    }

    if(o.status==="accepted"){
      acceptedDiv.innerHTML += card + `<div class="statusIcon tick">âœ”</div>`;
    }

    if(o.status==="rejected"){
      rejectedDiv.innerHTML += card + `<div class="statusIcon cross">âœ–</div>`;
    }
  });
});

window.setStatus = async (id, status) => {
  await updateDoc(doc(db,"orders",id), { status });
};

window.clearOne = async (id) => {
  if(confirm("Clear this pending order?")){
    await deleteDoc(doc(db,"orders",id));
  }
};

window.clearAllOrders = async () => {
  if(!confirm("Clear ALL accepted & rejected orders?")) return;
  const snap = await getDocs(collection(db,"orders"));
  snap.forEach(d=>{
    const o=d.data();
    if(o.status==="accepted" || o.status==="rejected"){
      deleteDoc(doc(db,"orders",d.id));
    }
  });
};
</script>

</body>
</html>